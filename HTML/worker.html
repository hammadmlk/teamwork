<html>
<head>
    <script src="./socket.io/socket.io.js"></script>
    <script src="./visualizeArray.js"></script>

    <link rel="stylesheet" href="stylesheet.css">        
</head>

<body>

    <div id="worker">
        <h1 id="heading">  Volunteer Worker Client  </h1>
        <p id="desc">  When you click 'connect to server' button. The browser will connect our server and help it solve a password cracking job. The server will use your computational resources...</p>
        
        <button onclick="connect()">connect with server</button>
        
        <h2>Stuff for nerds</h2>
        <p>connect: <span id="connect"> pending</span></p>
        <p>Getjob: <span id="getJob"> pending </span></p>
        <p>dojob: <span id="doJob"> pending</span></p>
        <p>respondToJob: <span id="respondToJob"> pending</span></p>
        <p>drawSolution: <span id="drawSolution"> pending</span></p>
        
        <div id="visualizeArea">
            <canvas id="gameCanvas"></canvas>
        </div>
        
    </div>
    
    <script>
        // handles:
        //  on job
        //  on solutionSpace
        
        window.alreadyWorking = 0;
        
        var socket; 
        function connect(){
            socket = io.connect('http://localhost:3000');
            
            // on socket connect, run function msg.
            socket.on('connect', msg("connect", "connected"))  
            
            socket.emit('newWorker', "");
            
            socket.on('job', function(data) {
                gotJob(data, socket);
            });
            
            socket.on('solutionSpace', function(solutionSpaceArray) {
                drawSolution(solutionSpaceArray);
            });
            
            // code here to refresh page on server disconnect?

        }


        /*function (data) {
        socket.emit('my other event', { my: 'data' });
        socket.send("test");
        }
        */
        function drawSolution (solutionSpaceArray){
            msg("drawSolution", "drew"+Math.random())
            visualizeArray(solutionSpaceArray);
        }
        
        function gotJob(jobData, socket){
            msg("getJob", "recieved job: "+ stringJobData(jobData))
            if (window.alreadyWorking !== 0){
                console.log("ALready working.........")
                return
            }else{
                window.alreadyWorking = 1;
            }
            var jobProgress=0;
            window.intervalHandle = setInterval(function(){
                ans = doJob(jobData, jobProgress)
                jobProgress = ans.jobProgress;
                jobData = ans.jobData;
                if (jobData.chunkStatus === 2){
                    console.log("-DONE-")
                    respondToJob(jobData, socket);
                    clearInterval(window.intervalHandle);
                }
                else if (jobData.chunkStatus === 1){
                    console.log("-DONE NOT FOUND-")
                    respondToJob(jobData, socket);
                    clearInterval(window.intervalHandle);
                }
            },1);
        }
        
        function doJob(jobData, jobProgress){
            //todo
            msg("doJob", "func reached. Progress: "+jobProgress+stringJobData(jobData))
            
            
            //todo: <fix exceeding chunk range issue> change to :
            //for (lastProgress to minof(lastProgress+100x, (chunknum+1)*chunkSize-1)???
            for (var i = 0; i<10000; i++){
                nextPassNum = jobData.chunkSize*jobData.chunkNumber+jobProgress
                //console.log("passnum: "+nextPassNum)
                if(jobData.chunkNumber>2023)
                    console.log(decimalTo26(nextPassNum))
                if ( /*hash*/(decimalTo26(nextPassNum)) === jobData.hash){
                    jobData.chunkStatus = 2;
                    jobData.password = decimalTo26(nextPassNum);
                    console.log("pass found: "+jobData.password)
                    
                }
                ++jobProgress;
            }
            if (jobProgress-1 > jobData.chunkSize){
                jobData.chunkStatus = 1; // complete no success
                console.log("pass not found: ")
            }
            
            var ans = {};
            ans.jobProgress = jobProgress;
            ans.jobData = jobData
            return ans;
        }

        //respond on job by sending jaoData on socket
        function respondToJob(jobData, socket){
            msg("respondToJob", "entered")
            socket.emit('jobResponse', jobData)
            window.alreadyWorking = 0;
        }
        
        function print (e){
        console.log(e);
        }
        function msg (elemId, text){
            document.getElementById(elemId).innerHTML = text;
        }

        function decimalTo26(decimal){
        // takes a decimal and returns the base 26 representation string of length 6.
        // [input-->output],  [0 --> aaaaaa], [25 --> aaaaaz], [26 --> aaaaba], [17575 --> aaazzz]
        // 26todec(alphabetIndex*26^place). example for bzz 1*26^2 + 25*26^1 + 25*26^0
        // a is like 0. so aaaazz == zz just like 0007 == 7
        
            //print("==========");
            var alphabets = ['a','b','c','d','e','f','g','h','i','j','k','l','m','n','o','p','q','r','s','t','u','v','w','x','y','z'];
            var divisor = decimal;
            var base=26; var qoutient; var remainder;
            var ans=[];
            do {
                quotient = Math.floor(divisor/base);
                remainder = divisor%base;
                //console.log("q:", quotient, "d:", divisor, "r:", remainder);
                divisor = quotient;            
                ans.push(alphabets[remainder]);
            } while (quotient>0)
            
            while (ans.length<6){
                ans.push(alphabets[0]);
            }
            
            ansx="";
            while(ans.length>0){
                ansx+=ans.pop();
            }
            //print (ansx);
            return ansx
        };
        
        // makes string of jobData struc
        function stringJobData(jobData){
                return "|\
                hash: " + jobData.hash + " | \
                senderId: " + jobData.senderId + " |  \
                chunkNum: " + jobData.chunkNumber + " | \
                chunkSize: " + jobData.chunkSize + " | \
                pass: " + jobData.password + " | \
                chunkStatus: " + jobData.chunkStatus + " | ";
            }
            
        
        
    </script>
</body>

</html>  